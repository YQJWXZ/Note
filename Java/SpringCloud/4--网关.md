# 网关

1. 网管功能：
* 身份认证和权限校验
* 服务路由、负载均衡
* 请求限流

## 1. 统一网关Gateway

### 1.1 搭建网关
1. 创建新的module，引入SpringCloudGateway的依赖和nacos的服务发现
```xml
<!--网管依赖-->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-gateway</artifactId>
</dependency>
<!--nacos服务发现依赖-->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
```
2. 编写路由配置及nacos地址
```yml
server:
  port: 10010  # 网关端口
spring:
  application:
    name: gateway # 服务名称
  cloud:
    nacos:
      server-addr: localhost:8848 # nacos地址
    gateway:
      routes: # 网关路由配置
        - id: user-service  # 路由id，自定义，只要唯一即可
          uri: lb://userservice # 路由的目标地址 lb就是负载均衡，后面跟服务名称
          predicates: # 路由断言，也就是判断请求是否符合路由规则的条件
            - Path=/user/**  # 这个就是按照路径匹配，只要以/user/开头就符合要求
        - id: order-service
          uri: lb://orderservice
          predicates:
            - Path=/order/**
```

### 1.2 路由断言工厂 Route Predicate Factory
> 作用：读取用户定义的断言条件，对请求做出判断

### 1.3 路由过滤器 GatewayFilter
1. 过滤器工厂 GatewayFilter Factories
2. 默认过滤器 (default-filters)
3. 全局过滤器(GlobalFilter)
> 区别在于GatewayFilter通过配置定义，处理逻辑是固定的。而GlobalFilter的逻辑需要自己写代码实现
* 实现GlobalFilter接口
```java
public interface GlobalFilter {
    /**
     * 处理当前请求，有必要的话通过{@link GatewayFilterChain}将请求交给下一个过滤器处理
     * @param exchange 请求上下文，里面可以获取Request、Response等信息
     * @param chain  用来把请求委托给下一个过滤器
     * @return  {@code Mono<Void>} 返回标示当前过滤器业务结束
     */
    Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain);
}
```

4. 过滤器执行顺序
* 每一个过滤器都必须指定一个int类型的order值，*order值越小，优先级越高，执行顺序越靠前*
* GlobalFilter通过实现Ordered接口，或者添加@Order注解来指定order值，由我们自己指定
* 路由过滤器和defaultFilter的order由Spring指定，默认是按照声明顺序从1递增
* 当过滤器的order值一样时，会按照*defaultFilter > 路由过滤器 > GlobalFilter* 的顺序执行

### 1.4 网关的cros跨域处理

1. 跨域：域名不一致就是跨域 ``域名不同、域名相同但端口不同``
2. 跨域问题：浏览器禁止请求的发起者与服务端发生跨域Ajax请求，请求被浏览器拦截的问题
3. 解决方案：CORS方案(配置方式)
```yml
spring:
  cloud:
    gateway:
      # ....
      globalcors: # 全局的跨域处理
        add-to-simple-url-handler-mapping: true # 解决options请求被拦截问题
        corsConfigurations:
        '[/**]':  # 拦截一切的跨域请求
          allowedOrigins: # 允许哪些网站的跨域请求
            - "http://localhost:8090"
            - "http://www.leyou.com"
          allowedMethods: # 允许的跨域ajax的请求方式
            - "GET"
            - "POST"
            - "DELETE"
            - "PUT"
            - "OPTIONS"
          allowedHeaders: "*" # 允许在请求中国携带的头信息
          allowCredentials: true # 是否允许携带cookie
          maxAge: 360000  # 这次跨域检测的有效期
```
## 2. zuul(阻塞式编程，不建议)