# 配置管理

## 1. Nacos配置管理

### 1.1 统一配置管理
> 项目启动 --> 读取nacos配置文件(bootstrap.yml) --> 读取本地配置文件(application.yml) --> 创建Spring容器 --> 加载bean

1. Nacos面板配置
* 配置文件的Data ID: [服务名称]-[profile].[后缀名]
* 分组： 默认即可
* 配置格式(yaml、properties)
* 配置内容(eg: pattern: dataformat: yyyy-MM-dd HH:mm:ss)

2. 引入Nacos的配置管理客户端依赖
```xml
    <dedpendency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
</dedpendency>
```
3. *在resource目录添加一个bootstrap.yml文件，这个文件就是引导文件，优先级高于application.yml*
```yml
spring:
  application:
    name: userservice # 服务名称
  profiles:
    active: dev  # 开发环境
  cloud:
    nacos:
      server-addr: localhost:8848  # Nacos地址
      config:
        file-extension: yaml  # 文件后缀名
```
4. 测试：将上面的pattern.dateformate属性注入到UserController中做测试

```java
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.Locale;

@RestController
@RequestMapping("/user")
public class UserController {
  // 注入nacos中的配置属性
  @Value("${pattern.dateformat}")
  private String dateformat;

  // 编写controller，通过日期格式化器来格式化现在时间并返回
  @GetMapping("now")
  public String now() {
    return LocalDate.now().format(DateTimeFormatter.ofPattern(dateformat, Locale.CHINA));
  }
}
```

### 1.2 配置热更新(自动更新)
1. 方式一：在@Value注入的变量所在类上添加注解@RefrechScope

2. 方式二：使用@ConfigurationProperties注解
> @ConfigurationProperties(profix = "pattern")

### 1.3 多环境配置共享

1. 多种配置的优先级：
> Nacos中的：服务名-profile.yaml > Nacos中的：服务名称.yaml > 本地配置

### 1.4 Nacos集群搭建
> nacos client --> Nginx --> 多个Nacos节点

1. 搭建集群的基本步骤
* 搭建数据库，初始化数据库表结构
* 下载nacos安装包
* 配置nacos
    * 进入nacos的conf目录，修改配置文件cluster.conf.example，重命名为cluster.conf
    * 进入cluster.conf中配置集群每一个节点信息
    * 修改application.properties文件，添加数据库配置(数据源spring.datasource.platform打开、数据库数量db.num打开、数据库地址、用户名打开)
    * 修改每一个端口号
* 启动nacos集群
> startup.cmd

* Nginx反向代理
    * 修改conf/nginx.conf文件，配置如下：
```conf
upstream nacos-cluster {
    server 127.0.0.1:8845;
    server 127.0.0.1:8846;
    server 127.0.0.1:8847;
} 

server {
    listen         80;
    server_name    localhost;
    
    location / nacos {
        proxy_pass http://nacos-cluster;
    }
}
```
